---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import CTA from '../../components/sections/CTA.astro';
import { getServices } from '../../lib/data';

const { slug } = Astro.params;

const services = await getServices();
const service = services.find((s: any) => s.slug === slug);

if (!service) {
  return Astro.redirect('/404');
}

// Support both old format (image: string) and new format (images: array)
const serviceImages = service.images && Array.isArray(service.images) && service.images.length > 0
  ? service.images
  : service.image
    ? [{ src: service.image, alt: service.title }]
    : [{ src: '/leistungen.png', alt: service.title }];

const serviceImage = serviceImages[0]?.src || '/leistungen.png';
---

<Layout
  title={service.title}
  description={service.shortDescription}
>
  <section class="pt-32 pb-16 bg-neutral-50">
    <div class="container">
      <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-sm text-neutral-500">
          <li><a href="/" class="hover:text-green-600">Startseite</a></li>
          <li><span class="mx-2">/</span></li>
          <li><a href="/leistungen/" class="hover:text-green-600">Leistungen</a></li>
          <li><span class="mx-2">/</span></li>
          <li class="text-neutral-900">{service.title}</li>
        </ol>
      </nav>

      <div class="grid gap-12 lg:grid-cols-2 items-center">
        <div>
          <h1 class="font-heading text-4xl md:text-5xl font-bold text-neutral-900 mb-6">
            {service.title}
          </h1>
          <p class="text-lg text-neutral-600 leading-relaxed">
            {service.shortDescription}
          </p>
        </div>
        <div>
          <img
            src={serviceImage}
            alt={service.title}
            class="rounded-xl shadow-lg w-full h-auto"
            loading="eager"
          />
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="max-w-3xl mx-auto">
        <h2 class="section-heading mb-8">Unsere Leistungen im Bereich {service.title}</h2>

        <ul class="space-y-4">
          {service.features.map((feature: string) => (
            <li class="flex items-start gap-4 p-4 bg-green-50 rounded-lg">
              <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
              <span class="text-neutral-700">{feature}</span>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </section>

  {/* Bildergalerie - nur anzeigen wenn mehr als 1 Bild */}
  {serviceImages.length > 1 && (
    <section class="section bg-neutral-50">
      <div class="container">
        <h2 class="section-heading text-center mb-12">Impressionen</h2>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {serviceImages.map((img: { src: string; alt?: string }, index: number) => (
            <button
              type="button"
              class="lightbox-trigger group block overflow-hidden rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer focus:outline-none focus:ring-2 focus:ring-green-500"
              data-index={index}
            >
              <img
                src={img.src}
                alt={img.alt || `${service.title} Bild ${index + 1}`}
                class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-300"
                loading="lazy"
              />
            </button>
          ))}
        </div>
      </div>
    </section>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center">
      <button id="lightbox-close" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 z-10">&times;</button>

      <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-5xl hover:text-gray-300 z-10 p-2">&#8249;</button>
      <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-5xl hover:text-gray-300 z-10 p-2">&#8250;</button>

      <img id="lightbox-img" src="" alt="" class="max-h-[90vh] max-w-[90vw] object-contain" />

      <div id="lightbox-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white text-sm"></div>
    </div>

    <script define:vars={{ images: serviceImages }}>
      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightbox-img');
      const lightboxCounter = document.getElementById('lightbox-counter');
      const triggers = document.querySelectorAll('.lightbox-trigger');
      let currentIndex = 0;

      function showImage(index) {
        if (index < 0) index = images.length - 1;
        if (index >= images.length) index = 0;
        currentIndex = index;
        lightboxImg.src = images[index].src;
        lightboxImg.alt = images[index].alt || '';
        lightboxCounter.textContent = `${index + 1} / ${images.length}`;
      }

      function openLightbox(index) {
        showImage(index);
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }

      function closeLightbox() {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
        document.body.style.overflow = '';
      }

      triggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
          const index = parseInt(trigger.dataset.index);
          openLightbox(index);
        });
      });

      document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
      document.getElementById('lightbox-prev').addEventListener('click', () => showImage(currentIndex - 1));
      document.getElementById('lightbox-next').addEventListener('click', () => showImage(currentIndex + 1));

      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) closeLightbox();
      });

      document.addEventListener('keydown', (e) => {
        if (lightbox.classList.contains('hidden')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
        if (e.key === 'ArrowRight') showImage(currentIndex + 1);
      });
    </script>
  )}

  <CTA
	  headline={`Fragen zu ${service.title}?`}
		    subheadline="Rufen Sie an oder schreiben Sie uns. Wir klÃ¤ren kurz, worum es geht, und machen Ihnen ein Angebot."
  />
</Layout>
